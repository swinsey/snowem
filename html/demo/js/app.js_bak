// Code goes here

'use strict';
var MEDIA_IPADDR = "media.peercall.vn";
var MEDIA_PORT = 443;
var SNW_DEMO = 0x44454D4F;
var SNW_DEMO_CONNECT = 1;
var SNW_DEMO_JOIN_ROOM = 2;
var SNW_DEMO_ROOM_READY = 3;

var app = angular.module('demo-app', ['angular-websocket', 'app.controllers', 'app.services', 'ui.bootstrap']);

//Setting up the app
app.config([ '$routeProvider', function( $routeProvider ) {

    // routes
    $routeProvider.
        when('/', {
            templateUrl: 'room.html',
            controller: 'MainCtrl'
        }).
        when('/:roomid/:flowid', {
            templateUrl: 'call.html',
            controller: 'MainCtrl'}).
        otherwise({
            redirectTo: '/drinks', 
            templateUrl: 'drinks_list.html',
            controller: 'MainCtrl'
        });

}]);

//Models
app.factory('Room', function($websocket) {
      var ws = $websocket('wss://'+ MEDIA_IPADDR + ':' + MEDIA_PORT + '/default');
      ws.onOpen(function(message) {
         console.log("websocket connected");
         ws.send({'msgtype': SNW_DEMO, 'api': SNW_DEMO_CONNECT});
      });

      ws.onMessage(function(evt) {
         //console.log("on message cb");
         if (room.OnMessageCB) room.OnMessageCB(evt);
      });

      var room = {};
      room.OnMessageCB = null;
      room.ws = ws;
      room.send = function(msg) {
         console.log("Sending message: " + JSON.stringify(msg));
         ws.send(msg);
      }
      room.setOnMessageCB = function(cb) {
         room.OnMessageCB = cb;
      }
      return room;
});

//CONTROLLERS
var controllers = angular.module('app.controllers',[]);

controllers.controller('MainCtrl', function( $scope, $location, $routeParams, Room, Drink)  {
  $scope.roomid = 0;
  $scope.flowid = 0;
  $scope.isInitiator = 0;
  $scope.Room = Room;
  Room.setOnMessageCB(function(evt) {
     var msg = JSON.parse(evt.data);
     console.log('Client received message:' + JSON.stringify(msg));
     if (msg.rc != null && msg.msgtype == SNW_DEMO ) {
        if (msg.rc != 0)
           return;
        if (msg.api == SNW_DEMO_CONNECT) {
           $scope.roomid = msg.room;
           $scope.flowid = msg.id;
           console.log("roomid:" + $scope.roomid);
           console.log("flowid:" + $scope.flowid);
        }
     } else if (msg.msgtype == SNW_DEMO) {
        if (msg.api == SNW_DEMO_ROOM_READY) {
           console.log("log room_ready");
        }

     }

  });

 
  if ($routeParams.roomid) {
    // get the detail info
    $scope.roomid = $routeParams.roomid;
    $scope.flowid = $routeParams.flowid;
    if ($routeParams.roomid == 0) {
      console.log("roomid is zero");
      //$scope.pageTitle = "Add Drink";
      //$scope.drink = new Drink();
      //$scope.ingredient_new = [];
  
    } else {

      console.log("join room: roomid=" + $routeParams.roomid + " flowid=" + $routeParams.flowid);
      $scope.Room.send({'msgtype':SNW_DEMO,'api': SNW_DEMO_JOIN_ROOM, 
        'roomid': parseInt($routeParams.roomid), 
        'flowid': parseInt($routeParams.flowid)});
   
    }
    
    // all three functions just cancel because can't do saves.
    $scope.cancel = function() {
      $location.path('/');
    }
  
  } else {
    // get the list info
    console.log("room page");
    //$scope.drinks = Drink.list();
    //console.log($scope.drinks);
    
    /*$scope.getDrink = function( drink ) {
      
      var newRoute = "/" + drink.id;
      $location.path( newRoute );
    
    };*/

    $scope.joinRoom = function(rid,fid) {
        var newRoute = "/" + rid + "/" + fid;
        $location.path( newRoute );
    };
 
  }
});

//SERVICES
var services = angular.module('app.services', [])

services.factory( 'Drink', function($http) {
    var Drink = function(data) { angular.extend(this, data); };

    Drink.get = function(drink) {
        return $http.get('drink.json').then(function(response) { return response.data; });
    };

    Drink.list = function() {
        return $http.get('drinks.json').then(function(response, status) { return response.data; })
    };

    return Drink;
});
