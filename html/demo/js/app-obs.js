"use strict";var MEDIA_IPADDR="media.peercall.vn",MEDIA_PORT=443,SNW_DEMO=1145392463,SNW_DEMO_CONNECT=1,SNW_DEMO_JOIN_ROOM=2,SNW_DEMO_ROOM_READY=3,SNW_DEMO_ICE_START=4,SNW_DEMO_ICE_SDP=5,SNW_DEMO_ICE_CANDIDATE=6,SNW_DEMO_MSG=7,constraints={audio:!0,video:{mandatory:{maxWidth:480,maxHeight:270,minWidth:480,minHeight:270}}},pcConfig={iceServers:[{urls:"stun:peercall.vn:8478"},{urls:"turn:peercall.vn:8479",credential:"webrtc",username:"webrtc"}],iceTransports:"relay"},pcConstraints={optional:[{DtlsSrtpKeyAgreement:!0},{RtpDataChannels:!0}]},app=angular.module("demo-app",["angular-websocket","app.controllers","app.services","ui.bootstrap"]);app.config(["$routeProvider",function(e){e.when("/",{templateUrl:"room.html",controller:"MainCtrl"}).when("/:roomid/:flowid",{templateUrl:"call.html",controller:"MainCtrl"}).otherwise({redirectTo:"/drinks",templateUrl:"drinks_list.html",controller:"MainCtrl"})}]),app.directive("myEnter",function(){return function(e,o,n){o.bind("keydown keypress",function(o){13===o.which&&(e.$apply(function(){e.$eval(n.myEnter)}),o.preventDefault())})}}),app.factory("Room",["$websocket",function(e){function o(e){console.log("icecandidate event: ",e),e.candidate?u.send({msgtype:SNW_DEMO,api:SNW_DEMO_ICE_CANDIDATE,flowid:u.flowid,peerid:u.peerid,candidate:{type:"candidate",label:e.candidate.sdpMLineIndex,id:e.candidate.sdpMid,candidate:e.candidate.candidate}}):console.log("End of candidates.")}function n(e){console.log("Remote stream added."),u.remoteVideo.src=window.URL.createObjectURL(e.stream),u.remoteStream=e.stream}function t(e){console.log("createOffer() error: ",e)}function i(e){console.log("Remote stream removed. Event: ",e)}function r(){try{u.pc=new RTCPeerConnection(pcConfig,pcConstraints),u.pc.onicecandidate=o,u.pc.onaddstream=n,u.pc.onremovestream=i,console.log("Created RTCPeerConnnection")}catch(e){return console.log("Failed to create PeerConnection, exception: "+e.message),void alert("Cannot create RTCPeerConnection object.")}}function a(e){u.pc.setLocalDescription(e),console.log("setLocalAndSendMessage sending message",e),u.send({msgtype:SNW_DEMO,api:SNW_DEMO_ICE_SDP,roomid:u.roomid,creatorid:u.flowid,peerid:u.peerid,sdp:e})}function s(){console.log("Sending offer to peer"),u.pc.createOffer(a,t)}function c(){console.log(">>>>>>> maybeStart() ",u.isStarted,u.localStream,u.isChannelReady),!u.isStarted&&null!==u.localStream&&u.isChannelReady&&(console.log(">>>>>> creating peer connection"),r(),console.log("log create"),u.pc.addStream(u.localStream),u.isStarted=!0,console.log("isInitiator: "+u.isInitiator),u.isInitiator&&(console.log("isInitiator: "+u.isInitiator),s()))}function l(e){console.log("Adding local stream."),u.localVideo=document.querySelector("#localVideo"),u.remoteVideo=document.querySelector("#remoteVideo"),u.localVideo.src=window.URL.createObjectURL(e),u.localStream=e,u.isInitiator&&(console.log("room.isInitiator: "+u.isInitiator),c())}function d(e){trace("Failed to create session description: "+e.toString())}function m(){console.log("Sending answer to peer."),u.pc.createAnswer().then(a,d)}function g(e){if(console.log("sdp: "+JSON.stringify(e)),"offer"===e.type)u.isInitiator||u.isStarted||(console.log("maybe start"),c()),u.pc.setRemoteDescription(new RTCSessionDescription(e)),m();else if("answer"===e.type)u.pc.setRemoteDescription(new RTCSessionDescription(e));else if("candidate"===e.type){var o=new RTCIceCandidate({sdpMLineIndex:e.label,candidate:e.candidate});u.pc.addIceCandidate(o)}}function p(e,o){var n={};n.name=e,n.msg=o,u.msgs.push(n);var t=document.getElementById("chat_msg_id");t.scrollTop=t.scrollHeight}var f=e("wss://"+MEDIA_IPADDR+":"+MEDIA_PORT+"/default");f.onOpen(function(e){console.log("websocket connected"),f.send({msgtype:SNW_DEMO,api:SNW_DEMO_CONNECT})}),f.onMessage(function(e){u.OnMessageCB&&u.OnMessageCB(e)});var u={};return u.roomid=0,u.flowid=0,u.peerid=0,u.OnMessageCB=null,u.ws=f,u.send=function(e){console.log("Sending message: "+JSON.stringify(e)),"object"==typeof message&&(e=JSON.stringify(e)),f.send(e)},u.isStarted=!1,u.isChannelReady=!1,u.isInitiator=!1,u.localVideo=null,u.remoteVideo=null,u.localStream=null,u.remoteStream=null,u.pc=null,u.startStream=function(){console.log("start stream"),navigator.mediaDevices.getUserMedia({audio:!0,video:{mandatory:{maxWidth:480,maxHeight:270,minWidth:480,minHeight:270}}}).then(l).catch(function(e){alert("getUserMedia() error: "+e.name)})},u.setOnMessageCB=function(e){u.OnMessageCB=e},u.setOnMessageCB(function(e){var o=JSON.parse(e.data);if(console.log("Client received message:"+JSON.stringify(o)),null!=o.rc&&o.msgtype==SNW_DEMO){if(console.log("response message:"+JSON.stringify(o)),0!=o.rc)return;o.api==SNW_DEMO_CONNECT&&(u.roomid=o.room,u.flowid=o.id,console.log("roomid:"+u.roomid),console.log("flowid:"+u.flowid)),o.api==SNW_DEMO_JOIN_ROOM&&(console.log("channel ready"),u.isChannelReady=!0)}else o.msgtype==SNW_DEMO&&(o.api==SNW_DEMO_ROOM_READY&&(u.flowid==o.creatorid?(console.log("creator room ready: "+JSON.stringify(o)),u.isInitiator=!0,u.peerid=o.peerid,c()):u.flowid==o.peerid&&(console.log("peerid room ready"),u.peerid=o.creatorid,c())),o.api==SNW_DEMO_ICE_SDP&&(console.log("got sdp: "+JSON.stringify(o.sdp)),g(o.sdp)),o.api==SNW_DEMO_ICE_CANDIDATE&&(console.log("got candidate: "+JSON.stringify(o.candidate)),g(o.candidate)),o.api==SNW_DEMO_MSG&&(console.log("got msg: "+JSON.stringify(o.candidate)),p("Friend",o.msg)))}),u.msgs=[],u.getMsgs=function(){return u.msgs},u.sendMsg=function(){var e={};e.msgtype=SNW_DEMO,e.api=SNW_DEMO_MSG,e.msg=u.msg,e.peerid=u.peerid,f.send(e),p("You",u.msg),u.msg=""},u}]);var controllers=angular.module("app.controllers",[]);controllers.controller("MainCtrl",["$scope","$location","$routeParams","Room","Drink",function(e,o,n,t,i){e.Room=t,n.roomid?(e.Room.roomid=parseInt(n.roomid),e.Room.flowid=parseInt(n.flowid),0==n.roomid?console.log("roomid is zero"):(console.log("join room: roomid="+e.Room.roomid+" flowid="+e.Room.flowid),e.Room.send({msgtype:SNW_DEMO,api:SNW_DEMO_JOIN_ROOM,roomid:parseInt(n.roomid),flowid:parseInt(n.flowid)}),t.startStream()),e.cancel=function(){o.path("/")},e.sendMsg=function(){console.log("enter pressed: "+e.Room.msg),e.Room.sendMsg()},e.getMsgs=function(){return e.Room.getMsgs()}):(console.log("room page"),e.joinRoom=function(e,n){var t="/"+e+"/"+n;o.path(t)})}]);var services=angular.module("app.services",[]);services.factory("Drink",["$http",function(e){var o=function(e){angular.extend(this,e)};return o.get=function(o){return e.get("drink.json").then(function(e){return e.data})},o.list=function(){return e.get("drinks.json").then(function(e,o){return e.data})},o}]);